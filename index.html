<!DOCTYPE html>

<html lang="en">
	<head>
		<title>jQuery Express.js File Upload</title>
		<meta charset="utf-8" />
        <link rel="icon" type="image/vnd.microsoft.icon" href="favicon.ico" />
	</head>

	<body>
		<h3>jQuery Express.js File Upload</h3>
		Select a file to upload:
		<br />

		<div>
			<form id="form" enctype="multipart/form-data" method="post">
				<h4>Case 1 : Using a Form</h4>
				<br />
				<input type="file" id="fileForm" required />
				<br />
				<input type="submit" value="Upload File" />
			</form>
		</div>

		<br />

		<div>
			<h4>Case 2 : Not Using a Form</h4>
			<br />
			<input type="file" id="fileNoForm" />
			<br />
			<input id="uploadButtonNoForm" type="button" value="Upload File" />
		</div>

		<script type="text/javascript" src="/jquery.min.js"></script>
		<script>
		
			function sendPostRequest(fileInputTagId) {
				//alert('sendPostRequest() : ' + fileInputTagId);

				// See https://stackoverflow.com/questions/5392344/sending-multipart-formdata-with-jquery-ajax :
				var data = new FormData();
				//jQuery.each(jQuery('#file')[0].files, function(i, file) {
				//	data.append('file-' + i, file);
				//});

				// See https://stackoverflow.com/questions/6974684/how-to-send-formdata-objects-with-ajax-requests-in-jquery :

				if (! $('#' + fileInputTagId)[0].files) {
					let message = "$('#' + fileInputTagId)[0].files is null; aborting POST.";
					console.error(message);
					alert(message);
					return;
				} else if ($('#' + fileInputTagId)[0].files.length == 0) {
					let message = "$('#' + fileInputTagId)[0].files.length is " + $('#' + fileInputTagId)[0].files.length + "; aborting POST.";
					console.error(message);
					alert(message);
					return;
				} else if (! $('#' + fileInputTagId)[0].files[0]) {
					let message = "$('#' + fileInputTagId)[0].files[0] is null; aborting POST.";
					console.error(message);
					alert(message);
					return;
				}

				var fileGoodness = $('#' + fileInputTagId)[0].files[0];
				console.log('fileGoodness:', fileGoodness);

				const fileKeyName = 'file';	// If fileKeyName is 'foo', the file data will be accessible in the server's app.post(req, res) event handler as req.files.foo
				data.append(fileKeyName, fileGoodness);

				$.ajax({
					url: '/',
					data: data,
					cache: false,
					processData: false,
					contentType: false,
					type: 'POST',
					success: function (result) {
						console.log('Ajax POST success! : ', result);
						alert('Ajax POST success! : ' + result);
					},
					error: function (error) {
						console.error('Ajax POST error:', error);
						//alert('Ajax POST error : ' + error);
						alert('Ajax POST error.');
					}
				});
			}

			$("#form").submit(function (event) {
				console.log('#form submit()');
				sendPostRequest('fileForm');
				event.preventDefault();
			});

			$("#uploadButtonNoForm").click(function () {
				console.log('#uploadButtonNoForm click');
				sendPostRequest('fileNoForm');
			});
		</script>
	</body>
</html>
